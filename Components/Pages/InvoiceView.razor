@page "/invoice/{SaleId:int}"
@rendermode InteractiveServer
@using AccountingApp.Services
@using AccountingApp.Models
@inject ISaleService SaleService
@inject IInvoiceService InvoiceService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Invoice</PageTitle>

@if (invoice == null)
{
    <div class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading invoice...</p>
        </div>
    </div>
}
else
{
    <div class="min-h-screen bg-gray-100 py-8">
        <div class="max-w-4xl mx-auto px-4">
            @* Print Button *@
            <div class="mb-4 flex justify-end gap-2 print:hidden">
                <button @onclick="PrintInvoice" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">
                    üñ®Ô∏è Print
                </button>
                <button @onclick="DownloadPdf" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all">
                    üìÑ Download PDF
                </button>
                <button @onclick="ShowEditModal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all">
                    ‚úèÔ∏è Edit Details
                </button>
                <button @onclick="GoBack" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all">
                    ‚Üê Back
                </button>
            </div>

            @* Invoice Container *@
            <div class="bg-white shadow-lg rounded-lg p-8 print:shadow-none" id="invoice-content">
                @* Header *@
                <div class="border-b-4 border-blue-500 pb-6 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-4xl font-bold text-blue-600 mb-2">INVOICE</h1>
                            <div class="text-gray-600">
                                <p class="font-semibold text-lg">Bookshop & Stationary</p>
                                <p>123 Main Street</p>
                                <p>City, Country</p>
                                <p>Phone: +92 300 1234567</p>
                                <p>Email: info@bookshop.com</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-600">Invoice Number</p>
                                <p class="text-2xl font-bold text-blue-600">@invoice.InvoiceNumber</p>
                                <p class="text-sm text-gray-600 mt-2">Sale Number</p>
                                <p class="font-mono text-sm">@invoice.Sale.SaleNumber</p>
                            </div>
                        </div>
                    </div>
                </div>

                @* Invoice Details & Customer Info *@
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-700">Bill To:</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-bold text-lg">@invoice.Sale.Customer.Name</p>
                            @if (!string.IsNullOrWhiteSpace(invoice.Sale.Customer.Phone))
                            {
                                <p class="text-gray-600">üìû @invoice.Sale.Customer.Phone</p>
                            }
                            @if (!string.IsNullOrWhiteSpace(invoice.Sale.Customer.Email))
                            {
                                <p class="text-gray-600">‚úâÔ∏è @invoice.Sale.Customer.Email</p>
                            }
                            @if (!string.IsNullOrWhiteSpace(invoice.Sale.Customer.Address))
                            {
                                <p class="text-gray-600">üìç @invoice.Sale.Customer.Address</p>
                            }
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-700">Invoice Details:</h3>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Invoice Date:</span>
                                <span class="font-semibold">@invoice.InvoiceDate.ToString("dd MMM yyyy")</span>
                            </div>
                            @if (invoice.PaymentDueDate.HasValue)
                            {
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Due Date:</span>
                                    <span class="font-semibold text-red-600">@invoice.PaymentDueDate.Value.ToString("dd MMM yyyy")</span>
                                </div>
                            }
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment Type:</span>
                                <span class="px-2 py-1 rounded text-xs font-semibold @(invoice.Sale.PaymentType == "Cash" ? "bg-green-100 text-green-800" : "bg-blue-100 text-blue-800")">
                                    @invoice.Sale.PaymentType
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                @* Items Table *@
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700">Items:</h3>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-blue-500 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left">Sr#</th>
                                    <th class="px-4 py-3 text-left">Item Name</th>
                                    <th class="px-4 py-3 text-right">Quantity</th>
                                    <th class="px-4 py-3 text-right">Unit Price</th>
                                    <th class="px-4 py-3 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{int srNo = 1;}
                                @foreach (var item in invoice.Sale.SaleItems)
                                {
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-4 py-3">@srNo</td>
                                        <td class="px-4 py-3">
                                            <div class="font-semibold">@item.Item.Name</div>
                                            @if (!string.IsNullOrWhiteSpace(item.Item.Description))
                                            {
                                                <div class="text-sm text-gray-500">@item.Item.Description</div>
                                            }
                                        </td>
                                        <td class="px-4 py-3 text-right">@item.Quantity</td>
                                        <td class="px-4 py-3 text-right">Rs. @item.UnitPrice.ToString("N2")</td>
                                        <td class="px-4 py-3 text-right font-semibold">Rs. @item.TotalPrice.ToString("N2")</td>
                                    </tr>
                                    srNo++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                @* Payment Summary *@
                <div class="flex justify-end mb-6">
                    <div class="w-full md:w-1/2">
                        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                            <div class="flex justify-between text-lg">
                                <span class="text-gray-600">Subtotal:</span>
                                <span class="font-semibold">Rs. @invoice.Sale.TotalAmount.ToString("N2")</span>
                            </div>
                            <div class="border-t pt-3">
                                <div class="flex justify-between text-2xl font-bold text-blue-600">
                                    <span>Grand Total:</span>
                                    <span>Rs. @invoice.Sale.TotalAmount.ToString("N2")</span>
                                </div>
                            </div>
                            <div class="border-t pt-3 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Amount Paid:</span>
                                    <span class="font-semibold text-green-600">Rs. @invoice.Sale.PaidAmount.ToString("N2")</span>
                                </div>
                                @if (invoice.Sale.RemainingAmount > 0)
                                {
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Balance Due:</span>
                                        <span class="font-semibold text-red-600">Rs. @invoice.Sale.RemainingAmount.ToString("N2")</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center">
                                        <span class="px-4 py-2 bg-green-100 text-green-800 rounded-lg font-semibold">‚úì PAID IN FULL</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @* Notes *@
                @if (!string.IsNullOrWhiteSpace(invoice.Sale.Notes))
                {
                    <div class="mb-6">
                        <h3 class="font-semibold text-lg mb-2 text-gray-700">Notes:</h3>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-gray-700">@invoice.Sale.Notes</p>
                        </div>
                    </div>
                }

                @* Footer *@
                <div class="border-t pt-6 mt-6">
                    <div class="text-center text-gray-600 space-y-2">
                        <p class="font-semibold">Terms & Conditions</p>
                        <p class="text-sm">Payment is due within 15 days from the invoice date.</p>
                        <p class="text-sm">Please make checks payable to: Bookshop & Stationary</p>
                        <p class="text-lg font-semibold text-blue-600 mt-4">Thank you for your business!</p>
                    </div>
                </div>

                @* Generated Date *@
                <div class="text-center text-xs text-gray-400 mt-6">
                    <p>Invoice generated on @invoice.GeneratedDate.ToString("dd MMM yyyy HH:mm")</p>
                </div>
            </div>
        </div>
    </div>
}

@* Edit Modal *@
@if (showEditModal)
{
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto print:hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 transform transition-all">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Edit Invoice Details</h2>
                <button @onclick="CloseEditModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="text-3xl">√ó</span>
                </button>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-gray-500 uppercase mb-2">Amount Paid (Rs.)</label>
                    <input type="number" @bind="editSale.PaidAmount" min="0" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-semibold text-lg">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Payment Type</label>
                        <select @bind="editSale.PaymentType" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                            <option value="Cash">üíµ Cash</option>
                            <option value="Bank">üè¶ Bank</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Due Date</label>
                        <input type="date" @bind="editSale.PaymentDueDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Internal Notes</label>
                    <textarea @bind="editSale.Notes" rows="3" placeholder="Add any revisions or remarks..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8">
                <button @onclick="CloseEditModal" class="px-6 py-3 text-gray-500 font-bold hover:text-gray-700 transition-colors">
                    Cancel
                </button>
                <button @onclick="UpdateInvoice" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-all hover:scale-105">
                    üíæ Update Invoice
                </button>
            </div>
        </div>
    </div>
}

<style>
    @@media print {
        body {
            background: white;
        }
        .print\\:hidden {
            display: none !important;
        }
        .print\\:shadow-none {
            box-shadow: none !important;
        }
    }
</style>

@code {
    [Parameter]
    public int SaleId { get; set; }

    private Invoice? invoice;
    private Sale editSale = new();
    private bool showEditModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoice();
    }

    private async Task LoadInvoice()
    {
        invoice = await InvoiceService.GetInvoiceBySaleIdAsync(SaleId);
        
        if (invoice == null)
        {
            // Generate invoice if it doesn't exist
            invoice = await InvoiceService.GenerateInvoiceAsync(SaleId);
        }
    }

    private async Task PrintInvoice()
    {
        await JSRuntime.InvokeVoidAsync("window.print");
    }

    private async Task DownloadPdf()
    {
        if (invoice == null) return;

        var pdfData = new
        {
            invoiceNum = invoice.InvoiceNumber,
            saleNum = invoice.Sale.SaleNumber,
            date = invoice.InvoiceDate.ToString("dd MMM yyyy"),
            dueDate = invoice.PaymentDueDate?.ToString("dd MMM yyyy"),
            paymentType = invoice.Sale.PaymentType,
            customerName = invoice.Sale.Customer.Name,
            customerPhone = invoice.Sale.Customer.Phone ?? "",
            customerAddress = invoice.Sale.Customer.Address ?? "",
            items = invoice.Sale.SaleItems.Select(i => new
            {
                name = i.Item.Name,
                qty = i.Quantity,
                price = i.UnitPrice.ToString("N2"),
                total = i.TotalPrice.ToString("N2")
            }).ToList(),
            subtotal = invoice.Sale.TotalAmount.ToString("N2"),
            paid = invoice.Sale.PaidAmount.ToString("N2"),
            total = invoice.Sale.TotalAmount.ToString("N2"),
            remaining = invoice.Sale.RemainingAmount.ToString("N2")
        };

        var fileName = $"Invoice_{invoice.InvoiceNumber}.pdf";
        await JSRuntime.InvokeVoidAsync("generateInvoicePdf", fileName, pdfData);
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/customers");
    }

    private void ShowEditModal()
    {
        if (invoice == null) return;
        
        editSale = new Sale
        {
            Id = invoice.Sale.Id,
            SaleNumber = invoice.Sale.SaleNumber,
            SaleDate = invoice.Sale.SaleDate,
            CustomerId = invoice.Sale.CustomerId,
            TotalAmount = invoice.Sale.TotalAmount,
            PaidAmount = invoice.Sale.PaidAmount,
            RemainingAmount = invoice.Sale.RemainingAmount,
            PaymentType = invoice.Sale.PaymentType,
            PaymentDueDate = invoice.Sale.PaymentDueDate,
            Notes = invoice.Sale.Notes,
            UserId = invoice.Sale.UserId
        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
    }

    private async Task UpdateInvoice()
    {
        if (invoice == null) return;

        try
        {
            await SaleService.UpdateAsync(editSale);
            await LoadInvoice(); // Refresh data
            showEditModal = false;
            await JSRuntime.InvokeVoidAsync("alert", "Invoice updated successfully! Changes have been synced with the income ledger.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error updating invoice: {ex.Message}");
        }
    }
}
