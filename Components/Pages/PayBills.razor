@page "/pay-bills"
@rendermode InteractiveServer
@using AccountingApp.Services
@using AccountingApp.Models
@inject IBillService BillService
@inject IJSRuntime JSRuntime

<div class="p-4 md:p-8 bg-gray-100 min-h-screen">
    <div class="mb-6 md:mb-8">
        <h1 class="text-4xl font-bold text-gray-800">üí≥ Pay Bills</h1>
        <p class="text-gray-500 mt-2">Select vendor bills and make payments</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-sm text-gray-500">Unpaid Bills</p>
            <p class="text-2xl font-bold text-red-600">@unpaidBills.Count(b => b.Status == "Unpaid")</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-sm text-gray-500">Partially Paid</p>
            <p class="text-2xl font-bold text-yellow-600">@unpaidBills.Count(b => b.Status == "Partial")</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-sm text-gray-500">Total Outstanding</p>
            <p class="text-2xl font-bold text-red-600">@unpaidBills.Sum(b => b.TotalAmount - b.PaidAmount).ToString("C")</p>
        </div>
    </div>

    <!-- Pay Modal -->
    @if (showPayForm)
    {
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">Pay Bill</h2>
                    <button @onclick="CancelPay" class="text-gray-500 hover:text-gray-700 text-xl">‚úñ</button>
                </div>

                @if (selectedBill != null)
                {
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-gray-500">Bill: <span class="font-semibold text-indigo-600">@selectedBill.BillNumber</span></p>
                        <p class="text-sm text-gray-500">Vendor: <span class="font-semibold">@selectedBill.Supplier?.SupplierName</span></p>
                        <p class="text-sm text-gray-500">Total: <span class="font-semibold">@selectedBill.TotalAmount.ToString("C")</span></p>
                        <p class="text-sm text-gray-500">Paid: <span class="font-semibold text-green-600">@selectedBill.PaidAmount.ToString("C")</span></p>
                        <p class="text-lg font-bold text-red-600 mt-2">Balance Due: @((selectedBill.TotalAmount - selectedBill.PaidAmount).ToString("C"))</p>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Amount *</label>
                            <input type="number" step="0.01" @bind="paymentAmount" max="@(selectedBill.TotalAmount - selectedBill.PaidAmount)" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                            <select @bind="paymentMethod" class="w-full px-4 py-2 border rounded-lg">
                                <option value="Cash">Cash</option>
                                <option value="Bank">Bank Transfer</option>
                                <option value="Cheque">Cheque</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
                            <input type="date" @bind="paymentDate" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reference No.</label>
                            <input type="text" @bind="paymentRef" placeholder="Cheque #, Receipt #" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea @bind="paymentNotes" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button @onclick="CancelPay" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">
                            Cancel
                        </button>
                        <button @onclick="MakePayment" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">
                            Pay Now
                        </button>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Payment History Modal -->
    @if (showHistory)
    {
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[80vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Payment History ‚Äî @historyBill?.BillNumber</h2>
                    <button @onclick="() => showHistory = false" class="text-gray-500 hover:text-gray-700 text-xl">‚úñ</button>
                </div>

                @if (billPayments.Any())
                {
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-sm">Date</th>
                                <th class="px-3 py-2 text-right text-sm">Amount</th>
                                <th class="px-3 py-2 text-left text-sm">Method</th>
                                <th class="px-3 py-2 text-left text-sm">Ref</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in billPayments)
                            {
                                <tr class="border-b">
                                    <td class="px-3 py-2 text-sm">@p.PaymentDate.ToString("dd MMM yyyy")</td>
                                    <td class="px-3 py-2 text-right text-sm font-semibold text-green-600">@p.Amount.ToString("C")</td>
                                    <td class="px-3 py-2 text-sm">@p.PaymentMethod</td>
                                    <td class="px-3 py-2 text-sm text-gray-500">@p.ReferenceNo</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-gray-500 text-center py-4">No payments yet.</p>
                }
            </div>
        </div>
    }

    <!-- Unpaid Bills Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full min-w-[800px]">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Bill #</th>
                        <th class="px-4 py-3 text-left font-semibold">Vendor</th>
                        <th class="px-4 py-3 text-left font-semibold">Due Date</th>
                        <th class="px-4 py-3 text-right font-semibold">Total</th>
                        <th class="px-4 py-3 text-right font-semibold">Paid</th>
                        <th class="px-4 py-3 text-right font-semibold">Balance</th>
                        <th class="px-4 py-3 text-center font-semibold">Status</th>
                        <th class="px-4 py-3 text-center font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!unpaidBills.Any())
                    {
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                ‚úÖ No outstanding bills! All bills are paid.
                            </td>
                        </tr>
                    }
                    @foreach (var bill in unpaidBills)
                    {
                        var balance = bill.TotalAmount - bill.PaidAmount;
                        <tr class="border-b hover:bg-gray-50 @(bill.DueDate < DateTime.Today ? "bg-red-50" : "")">
                            <td class="px-4 py-3 font-mono font-semibold text-indigo-600">@bill.BillNumber</td>
                            <td class="px-4 py-3 font-semibold">@bill.Supplier?.SupplierName</td>
                            <td class="px-4 py-3 @(bill.DueDate < DateTime.Today ? "text-red-600 font-bold" : "")">
                                @bill.DueDate.ToString("dd MMM yyyy")
                                @if (bill.DueDate < DateTime.Today)
                                {
                                    <span class="text-xs ml-1">‚ö†Ô∏è</span>
                                }
                            </td>
                            <td class="px-4 py-3 text-right">@bill.TotalAmount.ToString("C")</td>
                            <td class="px-4 py-3 text-right text-green-600">@bill.PaidAmount.ToString("C")</td>
                            <td class="px-4 py-3 text-right font-bold text-red-600">@balance.ToString("C")</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-medium @GetStatusBadge(bill.Status)">
                                    @bill.Status
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button @onclick="() => StartPayment(bill)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm mr-1">
                                    üí∞ Pay
                                </button>
                                <button @onclick="() => ShowPaymentHistory(bill)" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    üìú
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<Bill> unpaidBills = new();
    private Bill? selectedBill;
    private Bill? historyBill;
    private List<BillPayment> billPayments = new();
    private bool showPayForm = false;
    private bool showHistory = false;
    private decimal paymentAmount;
    private string paymentMethod = "Cash";
    private DateTime paymentDate = DateTime.Today;
    private string paymentRef = string.Empty;
    private string paymentNotes = string.Empty;
    private int currentUserId = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadBills();
    }

    private async Task LoadBills()
    {
        unpaidBills = await BillService.GetUnpaidBillsAsync(currentUserId);
    }

    private void StartPayment(Bill bill)
    {
        selectedBill = bill;
        paymentAmount = bill.TotalAmount - bill.PaidAmount;
        paymentMethod = "Cash";
        paymentDate = DateTime.Today;
        paymentRef = string.Empty;
        paymentNotes = string.Empty;
        showPayForm = true;
    }

    private async Task MakePayment()
    {
        if (selectedBill == null) return;

        var balance = selectedBill.TotalAmount - selectedBill.PaidAmount;
        if (paymentAmount <= 0 || paymentAmount > balance)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Payment amount must be between 0 and {balance:C}");
            return;
        }

        var payment = new BillPayment
        {
            BillId = selectedBill.Id,
            Amount = paymentAmount,
            PaymentMethod = paymentMethod,
            PaymentDate = paymentDate,
            ReferenceNo = paymentRef,
            Notes = paymentNotes,
            UserId = currentUserId
        };

        await BillService.PayBillAsync(payment);
        await LoadBills();
        CancelPay();
        await JSRuntime.InvokeVoidAsync("alert", "Payment recorded successfully!");
    }

    private async Task ShowPaymentHistory(Bill bill)
    {
        historyBill = bill;
        billPayments = await BillService.GetPaymentsAsync(bill.Id);
        showHistory = true;
    }

    private void CancelPay()
    {
        showPayForm = false;
        selectedBill = null;
    }

    private string GetStatusBadge(string status) => status switch
    {
        "Paid" => "bg-green-100 text-green-800",
        "Partial" => "bg-yellow-100 text-yellow-800",
        "Unpaid" => "bg-red-100 text-red-800",
        _ => "bg-gray-100 text-gray-800"
    };
}
