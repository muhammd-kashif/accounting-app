@page "/customers"
@rendermode InteractiveServer
@using AccountingApp.Services
@using AccountingApp.Models
@inject ICustomerService CustomerService
@inject ISaleService SaleService
@inject IProductService ProductService
@inject IInvoiceService InvoiceService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="p-4 md:p-8 bg-gray-100 min-h-screen">
    <div class="mb-6 md:mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">üõí Customer Sales</h1>
        <button @onclick="ShowAddForm" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full md:w-auto shadow-md">
            ‚ûï New Sale
        </button>
    </div>

    @* Search and Filters *@
    <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-end border border-gray-100">
        <div class="flex-1 w-full">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Search Customer / Sale #</label>
            <div class="relative">
                <input type="text" @bind="searchText" @bind:event="oninput" placeholder="Search..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-shadow shadow-sm focus:shadow-md">
                <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            </div>
        </div>
        <div class="w-full md:w-36">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">From Date</label>
            <input type="date" @bind="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm shadow-sm">
        </div>
        <div class="w-full md:w-36">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">To Date</label>
            <input type="date" @bind="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm shadow-sm">
        </div>
        <div class="flex flex-col items-end gap-1 w-full md:w-auto">
             <button @onclick="ResetFilters" class="text-xs font-semibold text-gray-500 hover:text-blue-600 transition-colors mb-1 self-end md:self-auto">
                Reset
            </button>
            <div class="flex gap-2 w-full">
                <button @onclick="ExportToCsv" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm shadow-md transition-transform active:scale-95">
                    üìä Export CSV
                </button>
                <button @onclick="ExportToPdf" class="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm shadow-md transition-transform active:scale-95">
                    üìÑ Export PDF
                </button>
            </div>
        </div>
    </div>

    @* Add/Edit Sale Modal *@
    @if (showForm)
    {
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 md:p-4 overflow-y-auto backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-4 md:p-6 my-4 md:my-8 relative">
                <div class="flex items-center justify-between mb-4 sticky top-0 bg-white z-10 pb-2 border-b md:border-none">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">@(isEditing ? "Edit Sale" : "New Sale Transaction")</h2>
                    <button @onclick="CancelForm" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">‚úñ</button>
                </div>

                <div class="space-y-4 overflow-y-auto max-h-[80vh] pb-20 md:pb-0 pr-1">
                    @* Customer Information *@
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h3 class="font-bold text-lg text-blue-800 mb-3 flex items-center gap-2">üë§ Customer Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <label class="text-xs font-bold uppercase text-blue-700 mb-1">Customer Name *</label>
                                <input type="text" @bind="newCustomer.Name" placeholder="Enter Full Name" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none @(validationErrors.Contains("Name") ? "border-red-500 bg-red-50" : "border-gray-300")">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-bold uppercase text-blue-700 mb-1">Phone Number *</label>
                                <input type="tel" @bind="newCustomer.Phone" placeholder="03XXXXXXXXX" maxlength="11" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none @(validationErrors.Contains("Phone") ? "border-red-500 bg-red-50" : "border-gray-300")">
                                <span class="text-[10px] text-blue-600/70 hidden md:block mt-1">Exactly 11 digits starting with 03</span>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-bold uppercase text-blue-700 mb-1">Email Address *</label>
                                <input type="email" @bind="newCustomer.Email" placeholder="example@domain.com" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none @(validationErrors.Contains("Email") ? "border-red-500 bg-red-50" : "border-gray-300")">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-bold uppercase text-blue-700 mb-1">Address *</label>
                                <input type="text" @bind="newCustomer.Address" placeholder="Full Address" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none @(validationErrors.Contains("Address") ? "border-red-500 bg-red-50" : "border-gray-300")">
                            </div>
                        </div>
                    </div>

                    @* Sale Information *@
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <h3 class="font-bold text-lg text-green-800 mb-3 flex items-center gap-2">üìÖ Sale Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs font-bold uppercase text-green-700 mb-1">Sale Date *</label>
                                <input type="date" @bind="newSale.SaleDate" class="px-4 py-2 border rounded-lg w-full focus:ring-2 focus:ring-green-400 outline-none @(validationErrors.Contains("Date") ? "border-red-500 bg-red-50" : "border-gray-300")">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase text-green-700 mb-1">Payment Due Date</label>
                                <input type="date" @bind="newSale.PaymentDueDate" class="px-4 py-2 border rounded-lg w-full focus:ring-2 focus:ring-green-400 outline-none border-gray-300">
                            </div>
                        </div>
                    </div>

                    @* Items Selection *@
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <h3 class="font-bold text-lg text-yellow-800 mb-3 flex items-center gap-2">üì¶ Items</h3>
                        
                        @* Add Item Row *@
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-3 items-end">
                            <div class="md:col-span-6">
                                <label class="text-xs font-bold uppercase text-yellow-700 mb-1">Select Product</label>
                                <select @bind="selectedItemId" class="px-4 py-2 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-yellow-400 outline-none bg-white">
                                    <option value="0">-- Select Item --</option>
                                    @foreach (var item in availableItems)
                                    {
                                        <option value="@item.Id">@item.ItemName - Rs. @item.SalePrice</option>
                                    }
                                </select>
                            </div>
                            <div class="grid grid-cols-12 gap-2 md:col-span-6">
                                <div class="col-span-8">
                                    <label class="text-xs font-bold uppercase text-yellow-700 mb-1">Quantity</label>
                                    <input type="number" @bind="selectedQuantity" min="1" placeholder="Qty" class="px-4 py-2 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-yellow-400 outline-none">
                                </div>
                                <div class="col-span-4">
                                    <button @onclick="AddItem" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg w-full h-[42px] transition-colors shadow-sm">
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        @* Selected Items List *@
                        @if (selectedItems.Any())
                        {
                            <div class="border border-yellow-200 rounded-lg overflow-hidden bg-white shadow-sm">
                                <table class="w-full text-sm">
                                    <thead class="bg-yellow-100/50 text-yellow-900 border-b border-yellow-100">
                                        <tr>
                                            <th class="px-3 py-2 text-left font-bold">Item</th>
                                            <th class="px-3 py-2 text-right font-bold">Qty</th>
                                            <th class="px-3 py-2 text-right font-bold hidden md:table-cell">Price</th>
                                            <th class="px-3 py-2 text-right font-bold">Total</th>
                                            <th class="px-3 py-2 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        @foreach (var item in selectedItems)
                                        {
                                            <tr class="hover:bg-yellow-50/30 transition-colors">
                                                <td class="px-3 py-2">
                                                    <div class="font-medium text-gray-800">@item.Product.ItemName</div>
                                                    <div class="md:hidden text-xs text-gray-500">@@ @item.UnitPrice.ToString("N0")</div>
                                                </td>
                                                <td class="px-3 py-2 text-right">@item.Quantity</td>
                                                <td class="px-3 py-2 text-right text-gray-600 hidden md:table-cell">Rs. @item.UnitPrice.ToString("N0")</td>
                                                <td class="px-3 py-2 text-right font-bold text-gray-800">Rs. @item.TotalPrice.ToString("N0")</td>
                                                <td class="px-3 py-2 text-right">
                                                    <button @onclick="() => RemoveItem(item)" class="text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50 transition-colors">
                                                        üóëÔ∏è
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot class="bg-yellow-50 border-t border-yellow-200">
                                        <tr>
                                            <td colspan="3" class="px-4 py-3 text-right font-bold text-gray-700 md:text-lg">Total Amount:</td>
                                            <td class="px-3 py-3 text-right font-bold text-lg text-green-600">Rs. @CalculateTotal().ToString("N0")</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-gray-400 text-center py-6 text-sm bg-white/50 rounded-lg border-2 border-dashed border-yellow-200">
                                No items added yet
                            </div>
                        }
                    </div>

                    @* Payment Details *@
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-purple-800 flex items-center gap-2">üí≥ Payment Details</h3>
                            <button @onclick="AddPaymentRow" class="bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs font-bold py-1 px-3 rounded-lg border border-purple-200 transition-colors">
                                ‚ûï Add Payment
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            @foreach (var payment in salePayments)
                            {
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-white p-3 rounded-lg border border-purple-100 shadow-sm md:bg-transparent md:border-0 md:shadow-none md:p-0">
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold uppercase text-purple-700 mb-1">Date</label>
                                        <input type="date" @bind="payment.PaymentDate" class="px-3 py-2 border border-gray-300 rounded-lg w-full text-sm focus:ring-2 focus:ring-purple-400 outline-none">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold uppercase text-purple-700 mb-1">Method</label>
                                        <select @bind="payment.PaymentMethod" class="px-3 py-2 border border-gray-300 rounded-lg w-full text-sm focus:ring-2 focus:ring-purple-400 outline-none bg-white">
                                            <option value="Cash">Cash</option>
                                            <option value="Bank">Bank</option>
                                            <option value="Card">Card</option>
                                            <option value="Cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-bold uppercase text-purple-700 mb-1">Amount</label>
                                        <input type="number" @bind="payment.Amount" min="0" step="0.01" class="px-3 py-2 border border-green-300 rounded-lg w-full text-sm font-bold text-green-700 focus:ring-2 focus:ring-purple-400 outline-none bg-green-50/30">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-xs font-bold uppercase text-purple-700 mb-1">Ref #</label>
                                        <input type="text" @bind="payment.ReferenceNo" placeholder="Optional" class="px-3 py-2 border border-gray-300 rounded-lg w-full text-sm focus:ring-2 focus:ring-purple-400 outline-none">
                                    </div>
                                    <div class="md:col-span-1 text-right flex justify-end">
                                        @if (salePayments.Count > 1)
                                        {
                                            <button @onclick="() => RemovePaymentRow(payment)" class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors" title="Remove Payment">
                                                üóëÔ∏è
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-xs font-bold uppercase text-purple-700 mb-1">Notes / Remarks</label>
                            <textarea @bind="newSale.Notes" placeholder="Any additional notes..." class="px-3 py-2 border border-gray-300 rounded-lg w-full text-sm h-20 focus:ring-2 focus:ring-purple-400 outline-none resize-none"></textarea>
                        </div>
                        
                        <div class="mt-4 flex flex-col md:flex-row justify-between items-center text-sm gap-3 bg-white p-3 rounded-lg border border-purple-200 shadow-sm">
                            <div class="font-bold text-purple-800">Total Paid: <span class="text-lg ml-2">Rs. @salePayments.Sum(p => p.Amount).ToString("N0")</span></div>
                            <div class="h-px w-full bg-purple-100 md:hidden"></div>
                            <div class="font-bold text-gray-700">
                                Remaining: 
                                <span class="text-lg ml-2 @(CalculateTotal() - salePayments.Sum(p => p.Amount) > 0 ? "text-red-600" : "text-green-600")">
                                    Rs. @((CalculateTotal() - salePayments.Sum(p => p.Amount)).ToString("N0"))
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-100 sticky bottom-0 bg-white z-20">
                    <button @onclick="CancelForm" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-lg w-full md:w-auto transition-colors">
                        Cancel
                    </button>
                    <button @onclick="SaveSale" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-8 rounded-lg w-full md:w-auto shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span>üíæ</span> Save Sale
                    </button>
                </div>
            </div>
        </div>
    }

    @* Edit Customer Modal *@
    @if (showEditCustomerModal)
    {
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Edit Customer</h2>
                    <button @onclick="() => showEditCustomerModal = false" class="text-gray-400 hover:text-gray-600 text-xl transition-colors">‚úñ</button>
                </div>
                <div class="space-y-4">
                    <div class="flex flex-col">
                        <label class="text-sm font-bold text-gray-700 mb-1">Customer Name *</label>
                        <input type="text" @bind="customerToEdit.Name" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-bold text-gray-700 mb-1">Phone Number *</label>
                        <input type="tel" @bind="customerToEdit.Phone" maxlength="11" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-bold text-gray-700 mb-1">Email *</label>
                        <input type="email" @bind="customerToEdit.Email" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-bold text-gray-700 mb-1">Address *</label>
                        <input type="text" @bind="customerToEdit.Address" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button @onclick="() => showEditCustomerModal = false" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-6 rounded-lg font-bold transition-colors">Cancel</button>
                    <button @onclick="UpdateCustomer" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-bold shadow-md transition-colors">Update Changes</button>
                </div>
            </div>
        </div>
    }

    @* Sales Data - Responsive *@
    <div>
         @* Mobile Table List View (Matches Screenshot Layout) *@
        <div class="block md:hidden bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
             @* Header Row *@
            <div class="bg-gray-100 px-4 py-3 flex text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-200">
                <div class="w-1/3">Sale #</div>
                <div class="w-2/3 pl-2">Customer Details</div>
            </div>

            @* Data Rows *@
            <div class="divide-y divide-gray-100">
                @foreach (var sale in PaginatedSales)
                {
                    <div class="flex px-4 py-4 hover:bg-gray-50 transition-colors items-start">
                        @* Left Column: Sale # and Date *@
                        <div class="w-1/3 flex flex-col pr-2">
                             <span class="font-bold text-gray-800 text-sm uppercase mb-1">@sale.SaleNumber</span>
                             <span class="text-xs text-gray-500 leading-tight">
                                 @sale.SaleDate.Day <br> 
                                 @sale.SaleDate.ToString("MMM yyyy")
                             </span>
                        </div>

                        @* Right Column: Customer Info and Actions *@
                        <div class="w-2/3 flex flex-col relative pl-2 border-l border-gray-100 min-h-[60px]">
                            <span class="font-bold text-gray-900 text-base leading-tight">@sale.Customer.Name</span>
                            <span class="text-xs text-gray-500 font-mono mt-1">@sale.Customer.Phone</span>
                            
                            @* Action Buttons (Absolute Positioned or Flex) *@
                            <div class="flex items-center justify-end gap-3 mt-3 ml-auto">
                                <button @onclick="() => EditSale(sale)" class="text-gray-400 hover:text-blue-600 transition-colors p-1" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <button @onclick="() => ViewLedger(sale.Customer.Id)" class="bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1 transition-colors">
                                    üìë Ledger
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Desktop Table View *@
        <div class="hidden md:block bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="w-full min-w-[1000px]">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Sale #</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Customer Details</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Paid</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Remaining</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        @foreach (var sale in PaginatedSales)
                        {
                            var status = GetSaleStatus(sale);
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 font-mono text-sm text-gray-600">
                                    <div class="font-bold text-gray-800">@sale.SaleNumber</div>
                                    <div class="text-xs text-gray-400">@sale.SaleDate.ToString("dd MMM yyyy")</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-gray-900">@sale.Customer.Name</span>
                                        <button @onclick="() => EditCustomer(sale.Customer)" class="text-gray-400 hover:text-blue-500 transition-colors" title="Edit Customer">‚úèÔ∏è</button>
                                    </div>
                                    <div class="text-xs text-gray-500 font-mono">@sale.Customer.Phone</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs text-gray-600">
                                        @foreach (var item in sale.SaleItems.Take(1))
                                        {
                                            <div>@item.Product.ItemName <span class="text-gray-400">x @item.Quantity</span></div>
                                        }
                                        @if (sale.SaleItems.Count > 1)
                                        {
                                            <div class="text-gray-400 italic text-[10px]">+@(sale.SaleItems.Count - 1) more...</div>
                                        }
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right font-medium text-gray-900">Rs. @sale.TotalAmount.ToString("N0")</td>
                                <td class="px-6 py-4 text-right text-green-600 font-medium">Rs. @sale.PaidAmount.ToString("N0")</td>
                                <td class="px-6 py-4 text-right">
                                    <span class="@(status == "Overdue" ? "text-red-600 font-bold" : "text-gray-600")">
                                        Rs. @sale.RemainingAmount.ToString("N0")
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider
                                        @(status == "Paid" ? "bg-green-100 text-green-800 border border-green-200" : 
                                          status == "Overdue" ? "bg-red-100 text-red-800 border border-red-200" : 
                                          "bg-yellow-100 text-yellow-800 border border-yellow-200")">
                                        @status
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex justify-center gap-2">
                                        <button @onclick="() => EditSale(sale)" class="text-gray-400 hover:text-yellow-600 transition-colors" title="Edit Sale">‚úèÔ∏è</button>
                                        <button @onclick="() => ViewInvoice(sale.Id)" class="text-gray-400 hover:text-blue-600 transition-colors" title="View Invoice">üìÑ</button>
                                        <button @onclick="() => ViewLedger(sale.Customer.Id)" class="text-gray-400 hover:text-green-600 transition-colors" title="Ledger">üìë</button>
                                        <button @onclick="() => ConfirmDeleteSale(sale.Id)" class="text-gray-400 hover:text-red-600 transition-colors" title="Delete Sale">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>@* Pagination *@
    <div class="mt-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-lg shadow-sm">
        <div class="text-sm text-gray-500">
            Showing <span class="font-bold text-gray-700">@(((currentPage - 1) * pageSize) + 1)</span> to <span class="font-bold text-gray-700">@(Math.Min(currentPage * pageSize, FilteredSales.Count))</span> of <span class="font-bold text-gray-700">@FilteredSales.Count</span> sales
        </div>
        <div class="flex items-center gap-2">
            <button @onclick="PreviousPage" disabled="@(currentPage == 1)" class="p-2 rounded-lg border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                ‰∏ä Prev
            </button>
            @for (int i = 1; i <= TotalPages; i++)
            {
                var pageNum = i;
                <button @onclick="() => GoToPage(pageNum)" class="w-10 h-10 rounded-lg border @(currentPage == pageNum ? "bg-blue-500 text-white border-blue-500" : "hover:bg-gray-100") font-bold">
                    @pageNum
                </button>
            }
            <button @onclick="NextPage" disabled="@(currentPage == TotalPages || TotalPages == 0)" class="p-2 rounded-lg border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                Next ‰∏ã
            </button>
            <select @bind="pageSize" class="ml-4 p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                <option value="10">10 / page</option>
                <option value="25">25 / page</option>
                <option value="50">50 / page</option>
            </select>
        </div>
    </div>

</div>

@code {
    private List<Sale> sales = new();
    private List<Product> availableItems = new();
    private List<Customer> allCustomers = new();
    private Customer newCustomer = new();
    private Sale newSale = new();
    private List<SaleItem> selectedItems = new();
    private List<SalePayment> salePayments = new();
    private List<string> validationErrors = new();
    
    // Step 5 State
    private string searchText = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private int currentPage = 1;
    private int pageSize = 10;
    
    private int selectedItemId = 0;
    private int selectedQuantity = 1;
    
    private bool showForm = false;
    private bool isEditing = false;
    private bool showEditCustomerModal = false;
    private Customer customerToEdit = new();
    private int currentUserId = 1; // Mock user ID

    protected override async Task OnInitializedAsync()
    {
        await LoadSales();
        await LoadItems();
        allCustomers = await CustomerService.GetAllAsync(currentUserId);
    }

    private async Task LoadSales()
    {
        sales = await SaleService.GetAllAsync(currentUserId);
    }

    private async Task LoadItems()
    {
        availableItems = await ProductService.GetAllAsync(currentUserId);
    }

    // --- STEP 5: Filtering & Pagination Logic ---
    private List<Sale> FilteredSales => sales
        .Where(s => 
            (string.IsNullOrWhiteSpace(searchText) || 
             (s.Customer?.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) || 
             (s.SaleNumber?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)) &&
            (!startDate.HasValue || s.SaleDate.Date >= startDate.Value.Date) &&
            (!endDate.HasValue || s.SaleDate.Date <= endDate.Value.Date)
        ).ToList();

    private List<Sale> PaginatedSales => FilteredSales
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    private int TotalPages => (int)Math.Ceiling((double)FilteredSales.Count / pageSize);

    private void GoToPage(int page) => currentPage = page;
    private void NextPage() => currentPage = Math.Min(currentPage + 1, TotalPages);
    private void PreviousPage() => currentPage = Math.Max(currentPage - 1, 1);

    private void ResetFilters()
    {
        searchText = "";
        startDate = null;
        endDate = null;
        currentPage = 1;
    }

    private string GetSaleStatus(Sale sale)
    {
        if (sale.RemainingAmount <= 0) return "Paid";
        
        // If remaining amount > 0, check due date
        if (sale.PaymentDueDate.HasValue && DateTime.Now.Date > sale.PaymentDueDate.Value.Date)
        {
            return "Overdue";
        }
        
        return "Pending";
    }

    private void EditCustomer(Customer customer)
    {
        customerToEdit = new Customer
        {
            Id = customer.Id,
            Name = customer.Name,
            Phone = customer.Phone,
            Email = customer.Email,
            Address = customer.Address,
            UserId = customer.UserId
        };
        showEditCustomerModal = true;
    }

    private async Task UpdateCustomer()
    {
        if (string.IsNullOrWhiteSpace(customerToEdit.Name)) return;
        
        await CustomerService.UpdateAsync(customerToEdit);
        showEditCustomerModal = false;
        await LoadSales(); // Reload to show updated customer info
    }

    private async Task EditSale(Sale sale)
    {
        var existing = await SaleService.GetByIdAsync(sale.Id);
        if (existing == null) return;

        newSale = new Sale
        {
            Id = existing.Id,
            SaleNumber = existing.SaleNumber,
            CustomerId = existing.CustomerId,
            SaleDate = existing.SaleDate,
            PaymentType = existing.PaymentType,
            TotalAmount = existing.TotalAmount,
            PaidAmount = existing.PaidAmount,
            RemainingAmount = existing.RemainingAmount,
            PaymentDueDate = existing.PaymentDueDate,
            Notes = existing.Notes,
            UserId = existing.UserId,
            CreatedDate = existing.CreatedDate
        };

        newCustomer = new Customer
        {
            Id = existing.Customer.Id,
            Name = existing.Customer.Name,
            Phone = existing.Customer.Phone,
            Email = existing.Customer.Email,
            Address = existing.Customer.Address,
            UserId = existing.Customer.UserId
        };

        selectedItems = existing.SaleItems.Select(si => new SaleItem
        {
            ProductId = si.ProductId,
            Product = si.Product,
            Quantity = si.Quantity,
            UnitPrice = si.UnitPrice,
            TotalPrice = si.TotalPrice
        }).ToList();

        salePayments = existing.Payments.Select(p => new SalePayment
        {
            Id = p.Id,
            SaleId = p.SaleId,
            PaymentDate = p.PaymentDate,
            Amount = p.Amount,
            PaymentMethod = p.PaymentMethod,
            ReferenceNo = p.ReferenceNo,
            Notes = p.Notes,
            UserId = p.UserId,
            CreatedDate = p.CreatedDate
        }).ToList();

        if (!salePayments.Any())
        {
            salePayments.Add(new SalePayment { PaymentDate = DateTime.Now, PaymentMethod = "Cash", Amount = 0 });
        }

        isEditing = true;
        showForm = true;
    }

    private async Task ConfirmDeleteSale(int saleId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this sale record? This will also remove the associated invoice/income entries.");
        if (confirmed)
        {
            await SaleService.DeleteAsync(saleId);
            await LoadSales();
        }
    }

    private void ShowAddForm()
    {
        newCustomer = new Customer { UserId = currentUserId };
        newSale = new Sale 
        { 
            UserId = currentUserId,
            SaleDate = DateTime.Now,
            PaymentType = "Cash",
            PaidAmount = 0
        };
        selectedItems = new List<SaleItem>();
        validationErrors = new();
        selectedItemId = 0;
        selectedQuantity = 1;
        isEditing = false;
        showForm = true;
        
        salePayments = new List<SalePayment> 
        { 
            new SalePayment { PaymentDate = DateTime.Now, PaymentMethod = "Cash", Amount = 0 } 
        };
    }

    private void AddPaymentRow()
    {
        salePayments.Add(new SalePayment { PaymentDate = DateTime.Now, PaymentMethod = "Cash", Amount = 0 });
    }

    private void RemovePaymentRow(SalePayment payment)
    {
        if (salePayments.Count > 1) salePayments.Remove(payment);
    }

    private async Task AddItem()
    {
        if (selectedItemId == 0 || selectedQuantity < 1) return;

        var item = availableItems.FirstOrDefault(i => i.Id == selectedItemId);
        if (item == null) return;

        // --- STEP 5: Stock Warning ---
        if (item.StockQuantity < selectedQuantity)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Warning: Low Stock! Only {item.StockQuantity} units available.");
            return;
        }

        var existing = selectedItems.FirstOrDefault(si => si.ProductId == selectedItemId);
        if (existing != null)
        {
            if (item.StockQuantity < (existing.Quantity + selectedQuantity))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Cannot add more. Total quantity exceeds stock.");
                return;
            }
            existing.Quantity += selectedQuantity;
            existing.TotalPrice = existing.Quantity * existing.UnitPrice;
        }
        else
        {
            selectedItems.Add(new SaleItem
            {
                ProductId = item.Id,
                Product = item,
                Quantity = selectedQuantity,
                UnitPrice = item.SalePrice,
                TotalPrice = selectedQuantity * item.SalePrice
            });
        }

        selectedItemId = 0;
        selectedQuantity = 1;
    }

    private void RemoveItem(SaleItem item) => selectedItems.Remove(item);

    private decimal CalculateTotal() => selectedItems.Sum(i => i.TotalPrice);

    private async Task SaveSale()
    {
        validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(newCustomer.Name)) validationErrors.Add("Name");
        
        if (string.IsNullOrWhiteSpace(newCustomer.Phone) || 
            newCustomer.Phone.Replace(" ", "").Replace("-", "").Length < 10) 
        {
            validationErrors.Add("Phone");
        }

        if (string.IsNullOrWhiteSpace(newCustomer.Email) || !newCustomer.Email.Contains("@")) // Fix: added fallback or relaxed
        {
            // validationErrors.Add("Email"); // Relaxed email validation
        }

        if (string.IsNullOrWhiteSpace(newCustomer.Address)) validationErrors.Add("Address");
        if (newSale.SaleDate == default) validationErrors.Add("Date");

        if (validationErrors.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Required fields missed! Name and Phone are mandatory.");
            return;
        }

        if (!selectedItems.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please add at least one item to the sale!");
            return;
        }

        // Save or find customer
        Customer customer;

        if (isEditing)
        {
            customer = await CustomerService.GetByIdAsync(newCustomer.Id);

            if (customer == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Customer not found!");
                return;
            }

            customer.Name = newCustomer.Name;
            customer.Phone = newCustomer.Phone;
            customer.Email = newCustomer.Email;
            customer.Address = newCustomer.Address;

            await CustomerService.UpdateAsync(customer);
        }
        else
        {
            newCustomer.Id = 0;
            newCustomer.UserId = currentUserId;
            newCustomer.CreatedDate = DateTime.Now;

            await CustomerService.AddAsync(newCustomer);

            allCustomers = await CustomerService.GetAllAsync(currentUserId);

            customer = allCustomers
                .OrderByDescending(c => c.Id)
                .FirstOrDefault();
        }


        if (customer == null) {
             await JSRuntime.InvokeVoidAsync("alert", "Error creating customer.");
             return;
        }

        newSale.CustomerId = customer.Id;
        
        // Handle PaymentType property in the background
        if (salePayments.Count == 1)
        {
            newSale.PaymentType = salePayments[0].PaymentMethod;
        }
        else if (salePayments.Count > 1)
        {
            newSale.PaymentType = "Split";
        }
        else
        {
            newSale.PaymentType = "Unpaid";
        }

        // Assign UserID
        newSale.UserId = currentUserId;
        
        if (isEditing)
        {
            await SaleService.UpdateAsync(newSale, salePayments);
        }
        else
        {
            await SaleService.CreateSaleAsync(newSale, selectedItems, salePayments);
        }

        await LoadSales();
        CancelForm();
    }

    private async Task ViewInvoice(int saleId)
    {
        await InvoiceService.GenerateInvoiceAsync(saleId);
        Navigation.NavigateTo($"/invoice/{saleId}");
    }

    private async Task EmailInvoice(Sale sale)
    {
        // Mock email functionality
        await JSRuntime.InvokeVoidAsync("alert", $"Invoice for {sale.SaleNumber} has been sent to {sale.Customer.Email}!");
    }

    private async Task ExportToPdf()
    {
        var headers = new string[] { "Sale #", "Date", "Customer", "Total", "Paid", "Remaining", "Status" };
        var body = FilteredSales.Select(s => new string[] 
        { 
            s.SaleNumber, 
            s.SaleDate.ToString("yyyy-MM-dd"), 
            s.Customer?.Name ?? "N/A", 
            $"Rs. {s.TotalAmount:N0}", 
            $"Rs. {s.PaidAmount:N0}", 
            $"Rs. {s.RemainingAmount:N0}", 
            GetSaleStatus(s) 
        }).ToList();

        var fileName = $"SalesExport_{DateTime.Now:yyyyMMdd}.pdf";
        await JSRuntime.InvokeVoidAsync("generateTablePdf", fileName, "Sales Report", headers, body);
    }

    private async Task ExportToCsv()
    {
        var csv = new System.Text.StringBuilder();
        csv.AppendLine("Sale Number,Date,Customer,Total,Paid,Remaining,Status");
        
        foreach (var sale in FilteredSales)
        {
            csv.AppendLine($"{sale.SaleNumber},{sale.SaleDate:yyyy-MM-dd},{sale.Customer.Name},{sale.TotalAmount},{sale.PaidAmount},{sale.RemainingAmount},{GetSaleStatus(sale)}");
        }

        var fileName = $"SalesExport_{DateTime.Now:yyyyMMdd}.csv";
        var bytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
        
        // Use JS to trigger download
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", Convert.ToBase64String(bytes));
    }

    private void CancelForm()
    {
        showForm = false;
        newCustomer = new();
        newSale = new();
        selectedItems = new();
        validationErrors = new();
    }

    private void ViewLedger(int customerId)
    {
        Navigation.NavigateTo($"/customer-ledger/{customerId}");
    }
}
