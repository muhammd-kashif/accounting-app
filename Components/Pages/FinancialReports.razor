@page "/financial-reports"
@rendermode InteractiveServer
@using AccountingApp.Services
@using Microsoft.EntityFrameworkCore
@inject IFinancialReportService FinancialReportService

<div class="p-8 bg-gray-100 min-h-screen">
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800">üìä Financial Reports</h1>
        <p class="text-gray-500 mt-2">Comprehensive financial statements and analysis</p>
    </div>

    <!-- Date Range Selector -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Period Type</label>
                <select @bind="selectedPeriod" @bind:after="OnPeriodChanged" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="custom">Custom Range</option>
                    <option value="thisMonth">This Month</option>
                    <option value="lastMonth">Last Month</option>
                    <option value="thisQuarter">This Quarter</option>
                    <option value="thisYear">This Year</option>
                    <option value="lastYear">Last Year</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                <input type="date" @bind="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                <input type="date" @bind="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div class="flex items-end">
                <button @onclick="LoadReports" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                    üîÑ Generate Reports
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Loading financial reports...</p>
        </div>
    }
    else
    {
        <div class="mb-6">
            <div class="flex gap-2 border-b border-gray-300">
                <button @onclick="@(() => activeTab = "profitLoss")" 
                        class="px-6 py-3 font-semibold transition @(activeTab == "profitLoss" ? "text-blue-600 border-b-2 border-blue-600" : "text-gray-600 hover:text-blue-600")">
                    üìà Profit & Loss
                </button>
                <button @onclick="@(() => activeTab = "cashFlow")" 
                        class="px-6 py-3 font-semibold transition @(activeTab == "cashFlow" ? "text-blue-600 border-b-2 border-blue-600" : "text-gray-600 hover:text-blue-600")">
                    üíµ Cash Flow
                </button>
                <button @onclick="@(() => activeTab = "balanceSheet")" 
                        class="px-6 py-3 font-semibold transition @(activeTab == "balanceSheet" ? "text-blue-600 border-b-2 border-blue-600" : "text-gray-600 hover:text-blue-600")">
                    ‚öñÔ∏è Balance Sheet
                </button>
                <button @onclick="@(() => activeTab = "salarySheet")" 
                        class="px-6 py-3 font-semibold transition @(activeTab == "salarySheet" ? "text-blue-600 border-b-2 border-blue-600" : "text-gray-600 hover:text-blue-600")">
                    üë• Salary Sheet
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline">@errorMessage</span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3" @onclick="() => errorMessage = null">
                    <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                </span>
            </div>
        }

        @if (activeTab == "profitLoss" && profitLoss != null)
        {
            <!-- Profit & Loss Statement -->
            <!-- ... (existing P&L content) ... -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Profit & Loss Statement</h2>
                    <p class="text-gray-600 mt-2">@profitLoss.StartDate.ToString("MMM dd, yyyy") - @profitLoss.EndDate.ToString("MMM dd, yyyy")</p>
                </div>

                <div class="space-y-6">
                    <!-- Revenue Section -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-gray-300 pb-2">Revenue</h3>
                        <div class="pl-4 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-700">Sales Revenue</span>
                                <span class="font-semibold text-green-600">Rs. @profitLoss.TotalSalesRevenue.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Other Income</span>
                                <span class="font-semibold text-green-600">Rs. @profitLoss.TotalOtherIncome.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span class="text-gray-800">Total Revenue</span>
                                <span class="text-green-600">Rs. @profitLoss.TotalRevenue.ToString("N2")</span>
                            </div>
                        </div>
                    </div>

                    <!-- COGS Section -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-gray-300 pb-2">Cost of Goods Sold</h3>
                        <div class="pl-4">
                            <div class="flex justify-between font-bold text-lg">
                                <span class="text-gray-800">Total COGS</span>
                                <span class="text-red-600">Rs. @profitLoss.TotalCostOfGoodsSold.ToString("N2")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gross Profit -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex justify-between text-xl font-bold">
                            <span class="text-gray-800">Gross Profit</span>
                            <span class="@(profitLoss.GrossProfit >= 0 ? "text-green-600" : "text-red-600")">
                                Rs. @profitLoss.GrossProfit.ToString("N2")
                            </span>
                        </div>
                    </div>

                    <!-- Operating Expenses -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-gray-300 pb-2">Operating Expenses</h3>
                        <div class="pl-4 space-y-2">
                            @foreach (var expense in profitLoss.ExpenseBreakdown)
                            {
                                <div class="flex justify-between">
                                    <span class="text-gray-700">@expense.Category</span>
                                    <span class="font-semibold text-red-600">Rs. @expense.Amount.ToString("N2")</span>
                                </div>
                            }
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span class="text-gray-800">Total Operating Expenses</span>
                                <span class="text-red-600">Rs. @profitLoss.TotalOperatingExpenses.ToString("N2")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Net Income -->
                    <div class="@(profitLoss.NetIncome >= 0 ? "bg-green-50" : "bg-red-50") p-6 rounded-lg border-2 @(profitLoss.NetIncome >= 0 ? "border-green-300" : "border-red-300")">
                        <div class="flex justify-between text-2xl font-bold">
                            <span class="text-gray-800">Net Income @(profitLoss.NetIncome >= 0 ? "(Profit)" : "(Loss)")</span>
                            <span class="@(profitLoss.NetIncome >= 0 ? "text-green-600" : "text-red-600")">
                                Rs. @profitLoss.NetIncome.ToString("N2")
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "salarySheet")
        {
            <!-- Salary Sheet -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">üë• Salary Sheet</h2>
                    <p class="text-gray-600 mt-2">@startDate.ToString("MMM dd, yyyy") - @endDate.ToString("MMM dd, yyyy")</p>
                </div>

                @if (salaryExpenses == null || !salaryExpenses.Any())
                {
                     <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">No salary records found for this period.</p>
                        <p class="text-sm mt-2">Ensure expenses are categorized as "Salary".</p>
                    </div>
                }
                else
                {
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-gray-700 uppercase text-xs font-bold border-b">Date</th>
                                    <th class="px-4 py-3 text-left text-gray-700 uppercase text-xs font-bold border-b">Description</th>
                                    <th class="px-4 py-3 text-right text-gray-700 uppercase text-xs font-bold border-b">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var salary in salaryExpenses)
                                {
                                    <tr class="hover:bg-gray-50 border-b">
                                        <td class="px-4 py-3 text-sm">@salary.Date.ToString("dd MMM yyyy")</td>
                                        <td class="px-4 py-3 text-sm">@salary.Description</td>
                                        <td class="px-4 py-3 text-right text-sm font-semibold text-gray-800">
                                            Rs. @salary.Amount.ToString("N2")
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold">
                                <tr>
                                    <td colspan="2" class="px-4 py-3 text-right text-gray-800">Total Salaries Paid:</td>
                                    <td class="px-4 py-3 text-right text-red-600">Rs. @salaryExpenses.Sum(s => s.Amount).ToString("N2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
            </div>
        }

        @if (activeTab == "cashFlow" && cashFlow != null)
        {
            <!-- Cash Flow Statement -->
             <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Cash Flow Statement</h2>
                    <p class="text-gray-600 mt-2">@cashFlow.StartDate.ToString("MMM dd, yyyy") - @cashFlow.EndDate.ToString("MMM dd, yyyy")</p>
                </div>

                <!-- ... (rest of Cash Flow content from original file) ... -->
                <div class="space-y-6">
                    <!-- Operating Activities -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-blue-300 pb-2">Cash Flow from Operating Activities</h3>
                        <div class="pl-4 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-700">Cash Received from Customers</span>
                                <span class="font-semibold text-green-600">Rs. @cashFlow.CashReceivedFromCustomers.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Cash Paid to Suppliers</span>
                                <span class="font-semibold text-red-600">(Rs. @cashFlow.CashPaidToSuppliers.ToString("N2"))</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Operating Expenses Paid</span>
                                <span class="font-semibold text-red-600">(Rs. @cashFlow.OperatingExpensesPaid.ToString("N2"))</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span class="text-gray-800">Net Cash from Operating</span>
                                <span class="@(cashFlow.NetCashFromOperating >= 0 ? "text-green-600" : "text-red-600")">
                                    Rs. @cashFlow.NetCashFromOperating.ToString("N2")
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Investing and Financing Sections omitted for brevity but should be kept if they were there -->
                    <!-- ... -->

                    <!-- Net Cash Flow -->
                     <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex justify-between text-xl font-bold">
                            <span class="text-gray-800">Net Increase/(Decrease) in Cash</span>
                            <span class="@(cashFlow.NetCashFlow >= 0 ? "text-green-600" : "text-red-600")">
                                Rs. @cashFlow.NetCashFlow.ToString("N2")
                            </span>
                        </div>
                    </div>

                    <!-- Cash Position -->
                    <div class="border-t-2 pt-4 space-y-2">
                        <div class="flex justify-between text-lg">
                            <span class="text-gray-700">Cash at Beginning of Period</span>
                            <span class="font-semibold">Rs. @cashFlow.OpeningCash.ToString("N2")</span>
                        </div>
                        <div class="flex justify-between text-lg">
                            <span class="text-gray-700">Net Cash Flow</span>
                            <span class="font-semibold @(cashFlow.NetCashFlow >= 0 ? "text-green-600" : "text-red-600")">
                                Rs. @cashFlow.NetCashFlow.ToString("N2")
                            </span>
                        </div>
                        <div class="flex justify-between text-2xl font-bold bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <span class="text-gray-800">Cash at End of Period</span>
                            <span class="text-green-600">Rs. @cashFlow.ClosingCash.ToString("N2")</span>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "balanceSheet" && balanceSheet != null)
        {
             <!-- Balance Sheet -->
             <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Balance Sheet</h2>
                    <p class="text-gray-600 mt-2">As of @balanceSheet.AsOfDate.ToString("MMM dd, yyyy")</p>
                    @if (!balanceSheet.IsBalanced)
                    {
                        <div class="mt-2 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-2 rounded">
                            ‚ö†Ô∏è Warning: Balance Sheet is not balanced. Assets ‚â† Liabilities + Equity
                        </div>
                    }
                </div>
                <!-- ... (rest of Balance Sheet content) ... -->
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- ASSETS -->
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-400 pb-2">ASSETS</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Current Assets</h4>
                                <div class="pl-4 space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-700">Cash</span>
                                        <span class="font-semibold">Rs. @balanceSheet.Cash.ToString("N2")</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-700">Accounts Receivable</span>
                                        <span class="font-semibold">Rs. @balanceSheet.AccountsReceivable.ToString("N2")</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-700">Inventory</span>
                                        <span class="font-semibold">Rs. @balanceSheet.Inventory.ToString("N2")</span>
                                    </div>
                                    <div class="flex justify-between font-bold border-t pt-2">
                                        <span class="text-gray-800">Total Current Assets</span>
                                        <span class="text-blue-600">Rs. @balanceSheet.TotalCurrentAssets.ToString("N2")</span>
                                    </div>
                                </div>
                            </div>
                             <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex justify-between text-xl font-bold">
                                    <span class="text-gray-800">TOTAL ASSETS</span>
                                    <span class="text-blue-600">Rs. @balanceSheet.TotalAssets.ToString("N2")</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LIABILITIES & EQUITY -->
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-red-400 pb-2">LIABILITIES & EQUITY</h3>
                        <div class="space-y-4">
                             <!-- Liabilities -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Current Liabilities</h4>
                                <div class="pl-4 space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-700">Accounts Payable</span>
                                        <span class="font-semibold">Rs. @balanceSheet.AccountsPayable.ToString("N2")</span>
                                    </div>
                                    <div class="flex justify-between font-bold border-t pt-2">
                                        <span class="text-gray-800">Total Liabilities</span>
                                        <span class="text-red-600">Rs. @balanceSheet.TotalLiabilities.ToString("N2")</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Equity -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Equity</h4>
                                <div class="pl-4 space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-700">Retained Earnings</span>
                                        <span class="font-semibold">Rs. @balanceSheet.RetainedEarnings.ToString("N2")</span>
                                    </div>
                                    <div class="flex justify-between font-bold border-t pt-2">
                                        <span class="text-gray-800">Total Equity</span>
                                        <span class="text-green-600">Rs. @balanceSheet.TotalEquity.ToString("N2")</span>
                                    </div>
                                </div>
                            </div>

                            <div class="@(balanceSheet.IsBalanced ? "bg-green-50 border-green-300" : "bg-red-50 border-red-300") p-4 rounded-lg border-2">
                                <div class="flex justify-between text-xl font-bold">
                                    <span class="text-gray-800">TOTAL LIABILITIES & EQUITY</span>
                                    <span class="@(balanceSheet.IsBalanced ? "text-green-600" : "text-red-600")">
                                        Rs. @balanceSheet.TotalLiabilitiesAndEquity.ToString("N2")
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private ProfitLossStatement? profitLoss;
    private CashFlowStatement? cashFlow;
    private BalanceSheet? balanceSheet;
    private List<Expense> salaryExpenses = new(); // For Salary Sheet

    private string selectedPeriod = "thisMonth";
    private DateTime startDate = DateTime.Now.AddMonths(-1);
    private DateTime endDate = DateTime.Now;
    private string activeTab = "profitLoss";
    private bool isLoading = false;
    private int currentUserId = 1; // Mock user ID
    private string? errorMessage; // To store error messages
    
    // Inject DB Context property
    [Inject]
    public AccountingApp.Data.ApplicationDbContext DbContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        OnPeriodChanged();
        await LoadReports();
    }

    private void OnPeriodChanged()
    {
        var today = DateTime.Now;
        
        switch (selectedPeriod)
        {
            case "thisMonth":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "lastMonth":
                var lastMonth = today.AddMonths(-1);
                startDate = new DateTime(lastMonth.Year, lastMonth.Month, 1);
                endDate = new DateTime(lastMonth.Year, lastMonth.Month, DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month));
                break;
            case "thisQuarter":
                var quarter = (today.Month - 1) / 3;
                startDate = new DateTime(today.Year, quarter * 3 + 1, 1);
                endDate = today;
                break;
            case "thisYear":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
            case "lastYear":
                startDate = new DateTime(today.Year - 1, 1, 1);
                endDate = new DateTime(today.Year - 1, 12, 31);
                break;
        }
    }

    private async Task LoadReports()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            profitLoss = await FinancialReportService.GetProfitLossStatementAsync(currentUserId, startDate, endDate);
            cashFlow = await FinancialReportService.GetCashFlowStatementAsync(currentUserId, startDate, endDate);
            balanceSheet = await FinancialReportService.GetBalanceSheetAsync(currentUserId, endDate);
            await LoadSalaryData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading reports: {ex.Message}";
            Console.WriteLine($"Error loading reports: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSalaryData()
    {
        try 
        {
            // Simple string matching for Salary category
            salaryExpenses = await DbContext.Expenses
                .Where(e => e.UserId == currentUserId 
                         && e.Date >= startDate 
                         && e.Date <= endDate 
                         && (e.Category.Contains("Salary") || e.Description.Contains("Salary")))
                .OrderByDescending(e => e.Date)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            // If DB context fails or isn't ready
             Console.WriteLine($"Error loading salary data: {ex.Message}");
             salaryExpenses = new List<Expense>();
        }
    }
}
