@page "/income"
@rendermode InteractiveServer
@using AccountingApp.Services
@using AccountingApp.Models
@inject IIncomeService IncomeService
@inject IInvoiceService InvoiceService
@inject ICustomerService CustomerService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="p-4 md:p-8 bg-gray-100 min-h-screen">
    <div class="mb-6 md:mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <h1 class="text-4xl font-bold text-gray-800">üí∞ Income Ledger</h1>
        <button @onclick="ShowAddForm" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-all hover:scale-105">
            ‚ûï Add Manual Income
        </button>
    </div>

    @* Summary Cards *@
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-blue-500">
            <p class="text-sm font-semibold text-gray-500 uppercase">Total Income</p>
            <h3 class="text-3xl font-bold text-gray-800">Rs. @TotalIncome.ToString("N2")</h3>
            <p class="text-xs text-gray-400 mt-2">Aggregated from filters</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-green-500">
            <p class="text-sm font-semibold text-gray-500 uppercase">Cash Collection</p>
            <h3 class="text-3xl font-bold text-green-600">Rs. @CashIncome.ToString("N2")</h3>
            <p class="text-xs text-gray-400 mt-2">Physical cash in hand</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-purple-500">
            <p class="text-sm font-semibold text-gray-500 uppercase">Bank Transfers</p>
            <h3 class="text-3xl font-bold text-purple-600">Rs. @BankIncome.ToString("N2")</h3>
            <p class="text-xs text-gray-400 mt-2">Digital payments received</p>
        </div>
    </div>

    @* Advanced Filters *@
    <div class="bg-white p-5 rounded-2xl shadow-sm mb-8 flex flex-wrap gap-4 items-end border border-gray-100">
        <div class="flex-1 min-w-[250px]">
            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Search Customer / Description</label>
            <div class="relative">
                <input type="text" @bind="searchText" @bind:event="oninput" placeholder="Search accounts..." class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <span class="absolute left-3 top-3.5 text-gray-400">üîç</span>
            </div>
        </div>
        <div class="w-full md:w-48">
            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">From Date</label>
            <input type="date" @bind="startDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="w-full md:w-48">
            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">To Date</label>
            <input type="date" @bind="endDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="w-full md:w-40">
            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Method</label>
            <select @bind="paymentFilter" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Types</option>
                <option value="Cash">üíµ Cash</option>
                <option value="Bank">üè¶ Bank</option>
            </select>
        </div>
        <div class="flex gap-2">
            <button @onclick="ResetFilters" class="px-6 py-3 text-gray-500 hover:text-blue-600 font-bold transition-colors">
                Reset
            </button>
            <button @onclick="ExportToCsv" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl flex items-center gap-2 shadow-md">
                üìä CSV
            </button>
            <button @onclick="ExportToPdf" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl flex items-center gap-2 shadow-md">
                üìÑ PDF
            </button>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    @if (showForm)
    {
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">@(isEditing ? "Edit Income" : "Add New Income")</h2>
                    <button @onclick="CancelForm" class="text-gray-500 hover:text-gray-700 text-xl">‚úñ</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <input type="date" @bind="newIncome.Date" class="md:col-span-2 px-4 py-2 border rounded-lg">
                    
                    <select @bind="newIncome.CustomerId" class="px-4 py-2 border rounded-lg">
                        <option value="0">Select Customer</option>
                        @foreach (var customer in customers)
                        {
                            <option value="@customer.Id">@customer.Name</option>
                        }
                    </select>

                    <select @bind="newIncome.PaymentType" class="px-4 py-2 border rounded-lg">
                        <option value="">Payment Type</option>
                        <option value="Cash">üíµ Cash</option>
                        <option value="Bank">üè¶ Bank</option>
                    </select>

                    <input type="number" @bind="newIncome.Amount" placeholder="Amount" class="md:col-span-2 px-4 py-2 border rounded-lg" step="0.01">
                    <textarea @bind="newIncome.Description" placeholder="Description" class="md:col-span-2 px-4 py-2 border rounded-lg" rows="3"></textarea>
                </div>

                <div class="flex justify-end gap-3">
                    <button @onclick="CancelForm" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">
                        Cancel
                    </button>
                    <button @onclick="SaveIncome" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">
                        Save
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Income Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full min-w-[900px]">
            <thead class="bg-gray-200">
                <tr>
                    <th class="px-6 py-3 text-left font-semibold">Date</th>
                    <th class="px-6 py-3 text-left font-semibold">Customer</th>
                    <th class="px-6 py-3 text-left font-semibold">Amount</th>
                    <th class="px-6 py-3 text-left font-semibold">Payment Type</th>
                    <th class="px-6 py-3 text-left font-semibold">Description</th>
                    <th class="px-6 py-3 text-left font-semibold">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var income in FilteredIncomes)
                {
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">@income.Date?.ToString("dd MMM yyyy")</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-700">@income.Customer?.Name</div>
                            <div class="text-xs text-gray-400">ID: #C-@income.CustomerId</div>
                        </td>
                        <td class="px-6 py-4 font-bold text-lg text-green-600">Rs. @income.Amount.ToString("N2")</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase @(income.PaymentType == "Cash" ? "bg-green-100 text-green-700" : "bg-purple-100 text-purple-700")">
                                @(income.PaymentType == "Cash" ? "üíµ Cash" : "üè¶ Bank")
                            </span>
                        </td>
                        <td class="px-6 py-4 text-gray-500 italic max-w-xs truncate">@income.Description</td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                @if (income.SaleId != null)
                                {
                                    <button @onclick="() => ViewInvoice(income.SaleId.Value)" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200" title="View Linked Invoice">
                                        üîó View Invoice
                                    </button>
                                }
                                else
                                {
                                    <button @onclick="() => EditIncome(income)" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition-colors" title="Edit Manual Entry">‚úèÔ∏è</button>
                                    <button @onclick="() => DeleteIncome(income.Id)" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors" title="Delete Manual Entry">üóëÔ∏è</button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<Income> incomes = new();
    private List<Customer> customers = new();
    private Income newIncome = new();
    private bool showForm = false;
    private string searchText = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private string paymentFilter = "";
    private bool isEditing = false;
    private int currentUserId = 1;

    // Computed Properties for Dashboard
    private List<Income> FilteredIncomes => incomes
        .Where(i => 
            (string.IsNullOrWhiteSpace(searchText) || 
             (i.Customer?.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) || 
             (i.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)) &&
            (!startDate.HasValue || (i.Date.HasValue && i.Date.Value.Date >= startDate.Value.Date)) &&
            (!endDate.HasValue || (i.Date.HasValue && i.Date.Value.Date <= endDate.Value.Date)) &&
            (string.IsNullOrWhiteSpace(paymentFilter) || i.PaymentType == paymentFilter)
        )
        .OrderByDescending(i => i.Date)
        .ToList();

    private decimal TotalIncome => FilteredIncomes.Sum(i => i.Amount);
    private decimal CashIncome => FilteredIncomes.Where(i => i.PaymentType == "Cash").Sum(i => i.Amount);
    private decimal BankIncome => FilteredIncomes.Where(i => i.PaymentType == "Bank").Sum(i => i.Amount);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        incomes = await IncomeService.GetAllAsync(currentUserId);
        customers = await CustomerService.GetAllAsync(currentUserId);
    }

    private void ShowAddForm()
    {
        newIncome = new Income { UserId = currentUserId, Date = DateTime.Now };
        isEditing = false;
        showForm = true;
    }

    private void EditIncome(Income income)
    {
        newIncome = new Income
        {
            Id = income.Id,
            Date = income.Date,
            CustomerId = income.CustomerId,
            Amount = income.Amount,
            PaymentType = income.PaymentType,
            Description = income.Description,
            UserId = income.UserId
        };
        isEditing = true;
        showForm = true;
    }

    private async Task SaveIncome()
    {
        if (newIncome.CustomerId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Customer select karein");
            return;
        }

        if (isEditing)
        {
            await IncomeService.UpdateAsync(newIncome);
        }
        else
        {
            await IncomeService.AddAsync(newIncome);
        }
        await LoadData();
        CancelForm();
    }

    private void ResetFilters()
    {
        searchText = "";
        startDate = null;
        endDate = null;
        paymentFilter = "";
    }

    private void ViewInvoice(int saleId)
    {
        Navigation.NavigateTo($"/invoice/{saleId}");
    }

    private async Task ExportToPdf()
    {
        var headers = new string[] { "Date", "Customer", "Amount", "Type", "Description" };
        var body = FilteredIncomes.Select(i => new string[] 
        { 
            i.Date?.ToString("yyyy-MM-dd") ?? "", 
            i.Customer?.Name ?? "N/A", 
            $"Rs. {i.Amount:N2}", 
            i.PaymentType ?? "", 
            i.Description ?? "" 
        }).ToList();

        var fileName = $"IncomeExport_{DateTime.Now:yyyyMMdd}.pdf";
        await JSRuntime.InvokeVoidAsync("generateTablePdf", fileName, "Income Report", headers, body);
    }

    private async Task ExportToCsv()
    {
        var csv = new System.Text.StringBuilder();
        csv.AppendLine("Date,Customer,Amount,Type,Description");
        
        foreach (var income in FilteredIncomes)
        {
            csv.AppendLine($"{income.Date:yyyy-MM-dd},{income.Customer?.Name},{income.Amount},{income.PaymentType},\"{income.Description}\"");
        }

        var fileName = $"IncomeExport_{DateTime.Now:yyyyMMdd}.csv";
        var bytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", Convert.ToBase64String(bytes));
    }

    private async Task DeleteIncome(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Delete karein?"))
        {
            await IncomeService.DeleteAsync(id);
            await LoadData();
        }
    }

    private void CancelForm()
    {
        showForm = false;
        newIncome = new();
    }
}
