

@page "/all-customers-ledger"
@rendermode InteractiveServer
@using AccountingApp.Services
@using AccountingApp.Models
@inject ICustomerService CustomerService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="p-4 md:p-8 bg-gray-50 min-h-screen">
    @* Header *@
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">üë• All Customers Ledger</h1>
            <p class="text-gray-600 mt-1">Overview of all customer balances and status</p>
        </div>
        <button @onclick="ExportToPdf" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center gap-2 w-full md:w-auto justify-center transition-transform hover:scale-105">
            <span>üìÑ</span> Export PDF
        </button>
    </div>

    @* Filters *@
    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-gray-200">
        <div class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-1 w-full">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Search Customers</label>
                <div class="relative">
                    <input type="text" @bind="searchText" @bind:event="oninput" placeholder="Search by name, phone..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-shadow shadow-sm focus:shadow-md" />
                    <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                </div>
            </div>
            
            <div class="w-full md:w-48">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Status</label>
                <select @bind="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm shadow-sm">
                    <option value="All">All Statuses</option>
                    <option value="Receivable">üî¥ Receivable</option>
                    <option value="Advance">üü¢ Advance</option>
                    <option value="Settled">‚ö™ Settled</option>
                </select>
            </div>

            <div class="w-full md:w-48">
                 <label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Sort By</label>
                <select @bind="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm shadow-sm">
                    <option value="Name">Name (A-Z)</option>
                    <option value="BalanceDesc">Highest Balance</option>
                    <option value="BalanceAsc">Lowest Balance</option>
                </select>
            </div>
        </div>
    </div>

    @* Summary Params *@
    @{
        var totalReceivable = FilteredCustomers.Where(c => c.NetBalance > 0).Sum(c => c.NetBalance);
        var totalAdvance = FilteredCustomers.Where(c => c.NetBalance < 0).Sum(c => Math.Abs(c.NetBalance));
    }

    @* Summary Stats Cards *@
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex justify-between items-center shadow-sm">
            <div>
                <p class="text-xs font-bold text-red-600 uppercase tracking-wider mb-1">Total Receivable</p>
                <p class="text-2xl font-bold text-red-800">Rs. @totalReceivable.ToString("N0")</p>
            </div>
            <div class="text-3xl opacity-50">üìâ</div>
        </div>
        <div class="bg-green-50 p-4 rounded-xl border border-green-100 flex justify-between items-center shadow-sm">
            <div>
                <p class="text-xs font-bold text-green-600 uppercase tracking-wider mb-1">Total Advance</p>
                <p class="text-2xl font-bold text-green-800">Rs. @totalAdvance.ToString("N0")</p>
            </div>
            <div class="text-3xl opacity-50">üìà</div>
        </div>
    </div>

    @* Customers List *@
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
        @if (!FilteredCustomers.Any())
        {
            <div class="text-center py-12">
                <div class="text-4xl mb-4 grayscale opacity-50">üì≠</div>
                <h3 class="text-lg font-bold text-gray-600">No customers found</h3>
                <p class="text-sm text-gray-500">Try adjusting your search or filters</p>
            </div>
        }
        else
        {
            <!-- Mobile List View (2-Column) -->
            <div class="block md:hidden">
                <div class="bg-gray-100 px-4 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider flex justify-between border-b border-gray-200">
                    <div>Customer</div>
                    <div>Balance</div>
                </div>
                <div class="divide-y divide-gray-100">
                    @foreach (var customer in PaginatedCustomers)
                    {
                        <div class="p-4 hover:bg-gray-50 transition-colors flex justify-between items-center cursor-pointer active:bg-blue-50" @onclick="() => NavigateToLedger(customer.CustomerId)">
                            @* Left: Name & Phone *@
                            <div class="flex flex-col gap-1">
                                <h3 class="font-bold text-gray-800 text-sm leading-tight">@customer.Name</h3>
                                <span class="text-xs text-gray-500 font-mono">@customer.Phone</span>
                                <span class="text-[10px] text-blue-600 font-bold mt-1">View Ledger ‚Üí</span>
                            </div>

                            @* Right: Balance & Status *@
                            <div class="text-right flex flex-col items-end gap-1">
                                <div class="font-bold text-sm @(customer.NetBalance > 0 ? "text-red-600" : customer.NetBalance < 0 ? "text-green-600" : "text-gray-600")">
                                    Rs. @Math.Abs(customer.NetBalance).ToString("N0")
                                </div>
                                <span class="text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider border
                                    @(customer.NetBalance > 0 ? "bg-red-50 text-red-700 border-red-100" : 
                                      customer.NetBalance < 0 ? "bg-green-50 text-green-700 border-green-100" : 
                                      "bg-gray-50 text-gray-600 border-gray-200")">
                                    @(customer.NetBalance > 0 ? "Receivable" : customer.NetBalance < 0 ? "Advance" : "Settled")
                                </span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full min-w-[800px]">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Customer Name</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Total Sales</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Total Received</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Net Balance</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @foreach (var customer in PaginatedCustomers)
                        {
                            <tr class="hover:bg-blue-50 transition-colors cursor-pointer group" @onclick="() => NavigateToLedger(customer.CustomerId)">
                                <td class="px-6 py-4">
                                    <div class="font-bold text-gray-800">@customer.Name</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-600">@customer.Phone</div>
                                    <div class="text-xs text-gray-400">@customer.Email</div>
                                </td>
                                <td class="px-6 py-4 text-right font-medium text-gray-700">
                                    Rs. @customer.TotalSales.ToString("N0")
                                </td>
                                <td class="px-6 py-4 text-right font-medium text-gray-700">
                                    Rs. @customer.TotalReceived.ToString("N0")
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="font-bold text-lg @(customer.NetBalance > 0 ? "text-red-600" : customer.NetBalance < 0 ? "text-green-600" : "text-gray-600")">
                                        Rs. @Math.Abs(customer.NetBalance).ToString("N0")
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        @(customer.NetBalance > 0 ? "(Dr)" : customer.NetBalance < 0 ? "(Cr)" : "-")
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm
                                        @(customer.NetBalance > 0 ? "bg-red-100 text-red-700 border border-red-200" : 
                                          customer.NetBalance < 0 ? "bg-green-100 text-green-700 border border-green-200" : 
                                          "bg-gray-100 text-gray-700 border border-gray-200")">
                                        @(customer.NetBalance > 0 ? "Receivable" : customer.NetBalance < 0 ? "Advance" : "Settled")
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <button class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow transition-all group-hover:scale-110" title="View Detail">
                                        ‚û°Ô∏è
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <div class="flex flex-col md:flex-row justify-between items-center p-4 border-t border-gray-200 bg-gray-50 gap-4">
                    <span class="text-sm text-gray-600">
                        Page <span class="font-bold">@currentPage</span> of <span class="font-bold">@totalPages</span>
                    </span>
                    <div class="flex gap-2">
                        <button class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-colors shadow-sm"
                                @onclick="PrevPage" disabled="@(currentPage == 1)">
                            ‚Üê Previous
                        </button>
                        <button class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-colors shadow-sm"
                                @onclick="NextPage" disabled="@(currentPage == totalPages)">
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<CustomerBalanceDto> customers = new();
    private string searchText = "";
    private string statusFilter = "All";
    private string sortBy = "Name";
    private int currentPage = 1;
    private int pageSize = 15;
    private int currentUserId = 1; // Mock

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            customers = await CustomerService.GetCustomerBalancesAsync(currentUserId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading customers: {ex.Message}");
        }
    }

    private IEnumerable<CustomerBalanceDto> FilteredCustomers
    {
        get
        {
            var query = customers.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                query = query.Where(c => c.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) || 
                                       (c.Phone?.Contains(searchText) ?? false) ||
                                       (c.Email?.Contains(searchText) ?? false));
            }

            if (statusFilter == "Receivable")
                query = query.Where(c => c.NetBalance > 0);
            else if (statusFilter == "Advance")
                query = query.Where(c => c.NetBalance < 0);
            else if (statusFilter == "Settled")
                query = query.Where(c => c.NetBalance == 0);

            switch (sortBy)
            {
                case "BalanceDesc":
                    query = query.OrderByDescending(c => c.NetBalance);
                    break;
                case "BalanceAsc":
                     query = query.OrderBy(c => c.NetBalance);
                    break;
                default:
                    query = query.OrderBy(c => c.Name);
                    break;
            }

            return query;
        }
    }

    private IEnumerable<CustomerBalanceDto> PaginatedCustomers => 
        FilteredCustomers.Skip((currentPage - 1) * pageSize).Take(pageSize);

    private int totalPages => (int)Math.Ceiling((double)FilteredCustomers.Count() / pageSize);

    private void NavigateToLedger(int customerId)
    {
        Navigation.NavigateTo($"/customer-ledger/{customerId}");
    }

    private async Task ExportToPdf()
    {
         var headers = new string[] { "Customer", "Phone", "Total Sales", "Received", "Net Balance" };
        var body = FilteredCustomers.Select(c => new string[] 
        { 
            c.Name, 
            c.Phone, 
            c.TotalSales.ToString("N0"), 
            c.TotalReceived.ToString("N0"), 
            c.NetBalance.ToString("N0") + (c.NetBalance > 0 ? " (Dr)" : c.NetBalance < 0 ? " (Cr)" : "")
        }).ToList();

        var fileName = $"All_Customers_Ledger_{DateTime.Now:yyyyMMdd}.pdf";
        await JSRuntime.InvokeVoidAsync("generateTablePdf", fileName, "All Customers Summary", headers, body);
    }
    
    private void PrevPage()
    {
        if (currentPage > 1) currentPage--;
    }

    private void NextPage()
    {
        if (currentPage < totalPages) currentPage++;
    }
}
