<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="app.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <HeadOutlet />
</head>

<body>
    <Routes />
    <script src="theme.js"></script>
    <script src="_framework/blazor.web.js"></script>
    <script src="_content/Blazor-ApexCharts/js/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        window.downloadFile = (fileName, contentType, base64Data) => {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = `data:${contentType};base64,${base64Data}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.generateInvoicePdf = (fileName, docContent) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            
            // --- Header Section ---
            doc.setFillColor(30, 41, 59); // Slate-800 (Premium Dark)
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(32);
            doc.setTextColor(255, 255, 255);
            doc.text("INVOICE", margin, 28);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("BOOKSHOP & STATIONARY", pageWidth - margin, 18, { align: "right" });
            doc.text("Main Market Road, City Center", pageWidth - margin, 23, { align: "right" });
            doc.text("Phone: +92 300 1234567 | info@bookshop.com", pageWidth - margin, 28, { align: "right" });
            
            // --- Decorative Line ---
            doc.setDrawColor(79, 70, 229); // Indigo-600
            doc.setLineWidth(1.5);
            doc.line(margin, 35, margin + 40, 35);

            // --- Billing & Meta Info ---
            doc.setTextColor(30, 41, 59);
            
            // Bill To Box
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text("BILL TO", margin, 60);
            doc.setFontSize(14);
            doc.text(docContent.customerName || "Walking Customer", margin, 68);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(71, 85, 105); // Gray-600
            if (docContent.customerPhone) doc.text(`Phone: ${docContent.customerPhone}`, margin, 74);
            if (docContent.customerAddress) doc.text(`Address: ${docContent.customerAddress}`, margin, 80);

            // Details Box
            doc.setTextColor(30, 41, 59);
            doc.setFont("helvetica", "bold");
            doc.text("INVOICE DETAILS", 130, 60);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            
            const detailX = 130;
            const detailValueX = 195;
            let currentMetaY = 68;
            
            const addMetaRow = (label, value, color) => {
                doc.setTextColor(71, 85, 105);
                doc.text(label, detailX, currentMetaY);
                if (color) doc.setTextColor(color[0], color[1], color[2]);
                else doc.setTextColor(30, 41, 59);
                doc.text(value, detailValueX, currentMetaY, { align: "right" });
                currentMetaY += 6;
            };

            addMetaRow("Invoice Date:", docContent.date);
            addMetaRow("Invoice #:", docContent.invoiceNum);
            addMetaRow("Sale #:", docContent.saleNum);
            addMetaRow("Payment:", docContent.paymentType);
            if (docContent.dueDate) addMetaRow("Due Date:", docContent.dueDate, [220, 38, 38]);

            // --- Items Table ---
            doc.autoTable({
                startY: 95,
                head: [['#', 'Description', 'Qty', 'Unit Price', 'Total']],
                body: docContent.items.map((i, idx) => [
                    idx + 1, 
                    i.name, 
                    i.qty, 
                    `Rs. ${i.price}`, 
                    `Rs. ${i.total}`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229], fontSize: 10, halign: 'center' },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 10 },
                    2: { halign: 'center', cellWidth: 15 },
                    3: { halign: 'right', cellWidth: 35 },
                    4: { halign: 'right', cellWidth: 35 }
                },
                styles: { fontSize: 9, cellPadding: 4 }
            });

            // --- Summary Section ---
            let finalY = doc.lastAutoTable.finalY + 15;
            if (finalY > 240) { doc.addPage(); finalY = 25; }

            const summaryWidth = 70;
            const summaryX = pageWidth - margin - summaryWidth;
            const rightAlignX = pageWidth - margin;

            doc.setFontSize(10);
            doc.setTextColor(71, 85, 105);
            doc.text("Subtotal:", summaryX, finalY);
            doc.setTextColor(30, 41, 59);
            doc.text(`Rs. ${docContent.subtotal}`, rightAlignX, finalY, { align: "right" });

            doc.setTextColor(71, 85, 105);
            doc.text("Amount Paid:", summaryX, finalY + 8);
            doc.setTextColor(22, 163, 74); // Green-600
            doc.text(`Rs. ${docContent.paid}`, rightAlignX, finalY + 8, { align: "right" });

            const remStr = (docContent.remaining || "0").toString().replace(/[^0-9.]/g, "");
            const remVal = parseFloat(remStr);
            
            if (remVal > 0.01) {
                doc.setFont("helvetica", "bold");
                doc.setTextColor(220, 38, 38); // Red-600
                doc.text("Due Payment:", summaryX, finalY + 16);
                doc.text(`Rs. ${docContent.remaining}`, rightAlignX, finalY + 16, { align: "right" });
            } else {
                doc.setFont("helvetica", "bold");
                doc.setTextColor(22, 163, 74);
                doc.text("PAID IN FULL", rightAlignX, finalY + 16, { align: "right" });
            }

            // Grand Total Highlight
            doc.setFillColor(248, 250, 252); // Slate-50
            doc.rect(summaryX - 5, finalY + 22, summaryWidth + 5, 15, 'F');
            doc.setDrawColor(226, 232, 240); // Slate-200
            doc.rect(summaryX - 5, finalY + 22, summaryWidth + 5, 15, 'S');

            doc.setFontSize(12);
            doc.setTextColor(79, 70, 229); // Indigo-600
            doc.text("Grand Total:", summaryX, finalY + 32);
            doc.text(`Rs. ${docContent.total}`, rightAlignX, finalY + 32, { align: "right" });

            // --- Footer ---
            doc.setFontSize(8);
            doc.setTextColor(148, 163, 184); // Slate-400
            doc.setFont("helvetica", "normal");
            doc.text("TERMS AND CONDITIONS", margin, 270);
            doc.text("1. All items are sold as-is. 2. No returns after 7 days. 3. Thank you for your support!", margin, 275);
            
            doc.setFontSize(9);
            doc.setTextColor(71, 85, 105);
            doc.text("Software Powered by AccountingApp Project", pageWidth / 2, pageHeight - 10, { align: "center" });

            doc.save(fileName);
        };

        window.generateTablePdf = (fileName, title, headers, body) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
            
            doc.setFontSize(18);
            doc.text(title, 14, 22);
            
            doc.autoTable({
                startY: 30,
                head: [headers],
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] }
            });
            
            doc.save(fileName);
        };
    </script>
</body>

</html>
